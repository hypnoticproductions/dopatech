<!DOCTYPE html>
<html>
<head>
    <title>Voice Agent Diagnostic</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        .log {
            margin: 5px 0;
            padding: 5px;
            background: #111;
            border-left: 3px solid #0f0;
        }
        .error { border-left-color: #f00; color: #f00; }
        .warning { border-left-color: #ff0; color: #ff0; }
        .success { border-left-color: #0f0; color: #0f0; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîç Voice Agent Diagnostic Tool</h1>
    <p>This will test the WebSocket connection to your Cloudflare Worker.</p>

    <button onclick="testConnection()">Test WebSocket Connection</button>
    <button onclick="clearLogs()">Clear Logs</button>

    <div id="logs"></div>

    <script>
        const workerUrl = 'wss://sitetalkr.richard-fproductions.workers.dev/';
        let ws = null;

        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function testConnection() {
            log('üîå Connecting to: ' + workerUrl, 'log');

            try {
                ws = new WebSocket(workerUrl);

                ws.onopen = () => {
                    log('‚úÖ WebSocket connected successfully!', 'success');
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì® Received: ${data.type || 'unknown type'}`, 'success');
                        log(`üì¶ Data: ${JSON.stringify(data, null, 2)}`, 'log');

                        // Check for specific event types
                        if (data.type === 'session.created') {
                            log('üéØ Session created successfully!', 'success');
                        }
                        if (data.type === 'error') {
                            log(`‚ùå Error from server: ${data.error}`, 'error');
                        }
                        if (data.type === 'response.audio.delta') {
                            log('üîä Audio data received!', 'success');
                        }
                    } catch (err) {
                        log(`‚ö†Ô∏è Received non-JSON message: ${event.data}`, 'warning');
                    }
                };

                ws.onerror = (error) => {
                    log(`‚ùå WebSocket error occurred`, 'error');
                    console.error('WebSocket error:', error);
                };

                ws.onclose = (event) => {
                    log(`üîå WebSocket closed. Code: ${event.code}, Reason: ${event.reason}`, 'warning');
                };

            } catch (error) {
                log(`‚ùå Failed to create WebSocket: ${error.message}`, 'error');
            }
        }

        // Auto-run test on load
        setTimeout(testConnection, 500);
    </script>
</body>
</html>
